services:
  # Apache Proxy - Routes Nintendo domains to backend services
  # Note: With mariadb profile, Apache will proxy to GTS; without it, gamestats2 will be unavailable
  apache:
    build:
      context: .
      dockerfile: docker/Dockerfile.apache-sslv3
    container_name: dwc-apache
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./logs/apache:/usr/local/apache2/logs
    depends_on:
      gamespy:
        condition: service_started
      gts:
        condition: service_started
        required: false
    networks:
      - dwc-network

  # DNS Server for Nintendo domains
  dnsmasq:
    container_name: dnsmasq
    image: strm/dnsmasq
    restart: always
    volumes:
      - ./dnsmasq/wfc.conf:/etc/dnsmasq.d/wfc.conf
    ports:
      - "53:53/tcp"
      - "53:53/udp"
    cap_add:
      - NET_ADMIN
    networks:
      - dwc-network

  # MariaDB Database (optional - use SQLite if not needed)
  # Note: Using MariaDB 10.5 for compatibility with Mono/.NET MySQL connector
  mariadb:
    image: mariadb:10.5
    container_name: dwc-mariadb
    restart: unless-stopped
    command: --lower-case-table-names=1 --character-set-server=utf8 --collation-server=utf8_general_ci
    environment:
      MYSQL_ROOT_PASSWORD: ${DATABASE_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: ${DATABASE_NAME:-dwc_server}
      MYSQL_USER: ${DATABASE_USER:-dwc}
      MYSQL_PASSWORD: ${DATABASE_PASSWORD:-changeme}
    volumes:
      - mariadb-data:/var/lib/mysql
    ports:
      - "3306:3306"
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - dwc-network
    profiles:
      - mariadb  # Only start if explicitly requested

  # Django Admin Panel
  admin:
    build:
      context: .
      dockerfile: docker/Dockerfile.admin
    container_name: dwc-admin
    restart: unless-stopped
    ports:
      - "7999:7999"
    expose:
      - "7999" 
    environment:
      - DATABASE_ENGINE=${DATABASE_ENGINE:-sqlite}
      - DATABASE_NAME=${DATABASE_NAME:-/app/data/dwc_server.db}
      - DATABASE_USER=${DATABASE_USER:-dwc}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD:-changeme}
      - DATABASE_HOST=${DATABASE_HOST:-mariadb}
      - DATABASE_PORT=${DATABASE_PORT:-3306}
      - SECRET_KEY=${SECRET_KEY:-change-me-in-production}
      - DEBUG=${DEBUG:-False}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-*}
      - DJANGO_PORT=${DJANGO_PORT:-7999}
      - GUNICORN_WORKERS=${GUNICORN_WORKERS:-2}
      - GUNICORN_TIMEOUT=${GUNICORN_TIMEOUT:-120}
      # Superuser auto-creation (optional)
      - DJANGO_SUPERUSER_USERNAME=${DJANGO_SUPERUSER_USERNAME:-}
      - DJANGO_SUPERUSER_PASSWORD=${DJANGO_SUPERUSER_PASSWORD:-}
      - DJANGO_SUPERUSER_EMAIL=${DJANGO_SUPERUSER_EMAIL:-}
      # API Token for GameSpy server
      - NAS_API_TOKEN=${NAS_API_TOKEN:-}
    volumes:
      - ./data:/app/data  # Shared with gamespy for SQLite
      - ./logs:/app/logs
      - static-files:/app/admin_panel/staticfiles
    depends_on:
      mariadb:
        condition: service_healthy
        required: false
    networks:
      - dwc-network
    #healthcheck:
    #  test: ["CMD", "curl", "-f", "http://localhost:7999/api/"]
    #  interval: 30s
    #  timeout: 10s
    #  retries: 3
    #  start_period: 40s

  # GameSpy Servers (NAS, GP, QR)
  gamespy:
    build:
      context: .
      dockerfile: docker/Dockerfile.gamespy
    container_name: dwc-gamespy
    restart: unless-stopped
    expose:
      - "8080"   # NAS (internal only, apache/nginx proxies)
      - "9003"   # DLS1
      - "8000"   # Storage
    ports:
      - "29900:29900"    # GP (TCP) - direct access
      - "27900:27900/udp" # QR (UDP) - direct access
      - "9003:9003"
      - "8000:8000"
    environment:
      - NAS_HOST=0.0.0.0
      - NAS_PORT=8080
      - GP_HOST=0.0.0.0
      - GP_PORT=29900
      - QR_HOST=0.0.0.0
      - QR_PORT=27900
      - DLS1_HOST=0.0.0.0
      - DLS1_PORT=9003
      - DATABASE_URL=${API_BASE_URL:-http://admin:7999/api}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./data:/app/data  # Shared with admin for SQLite
      - ./logs:/app/logs
    depends_on:
      - admin
    networks:
      - dwc-network
    #healthcheck:
    #  test: ["CMD", "python", "-c", "import socket; socket.create_connection(('localhost', 29900), timeout=5)"]
    #  interval: 30s
    #  timeout: 10s
    #  retries: 3
    #  start_period: 10s

  # GTS Server (Pokemon Global Trade Station)
  gts:
    build:
      context: .
      dockerfile: docker/Dockerfile.gts
      args:
        - GTS_DB_NAME=${GTS_DB_NAME:-gts}
        - GTS_DB_USER=${GTS_DB_USER:-gts}
        - GTS_DB_PASSWORD=${GTS_DB_PASSWORD:-gts}
        - MARIADB_HOST=dwc-mariadb
    container_name: dwc-gts
    restart: unless-stopped
    expose:
      - "9002"   # GTS web service (proxied by Apache)
    environment:
      - GTS_DB_NAME=${GTS_DB_NAME:-gts}
      - GTS_DB_USER=${GTS_DB_USER:-gts}
      - GTS_DB_PASSWORD=${GTS_DB_PASSWORD:-gts}
      - MARIADB_HOST=dwc-mariadb
      - MARIADB_ROOT_PASSWORD=${DATABASE_ROOT_PASSWORD:-rootpassword}
    depends_on:
      mariadb:
        condition: service_healthy
    networks:
      - dwc-network
    profiles:
      - mariadb  # GTS requires MariaDB

volumes:
  mariadb-data:
    driver: local
  static-files:
    driver: local

networks:
  dwc-network:
    driver: bridge